volumes:
  pg_master_data:
    driver: local
  postgres-backups:
    driver: local
  backup-archive:
    driver: local
  postgres-socket:
    driver: local

networks:
  pgnet:
    driver: bridge

x-postgres-common:
  &postgres-common
  image: postgres:14.13-alpine
  user: postgres
  restart: always
  healthcheck:
    test: 'pg_isready -U postgres --dbname=postgres'
    interval: 10s
    timeout: 5s
    retries: 5

services:
  postgres-master:
    <<: *postgres-common
    container_name: ems-postgres-master
    environment:
      POSTGRES_USER: ${POSTGRES_MASTER_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_MASTER_PASSWORD:-masterpass}
#      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_MASTER_HOST_AUTH_METHOD:-"scram-sha-256\nhost replication replicator 0.0.0.0/0 md5"}
#      POSTGRES_INITDB_ARGS: ${POSTGRES_MASTER_INITDB_ARGS:-"--auth-host=scram-sha-256"}
      LANG: C.UTF-8
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf" ]
    volumes:
      - pg_master_data:/var/lib/postgresql/data
      - ./postgres/master/postgres.conf:/etc/postgresql/postgresql.conf:ro
      - ./postgres/master/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - postgres-backups:/backups
      - postgres-socket:/var/run/postgresql
#      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - pgnet
    ports:
      - "${POSTGRES_MASTER_PORT:-5432}:5432"

  # pgBackRest for Backup Management
  pgbackrest:
    image: woblerr/pgbackrest:2.56.0-alpine
    container_name: ems-pgbackrest
    hostname: pgbackrest-v1
    user: "70:70"
    environment:
      PGBACKREST_STANZA: main
      PGBACKREST_REPO1_PATH: /backup
      PGBACKREST_REPO1_RETENTION_FULL: ${BACKUP_RETENTION_FULL:-4}
      BACKUP_ENCRYPTION_KEY: ${BACKUP_ENCRYPTION_KEY:-changeme}
    volumes:
      - pg_master_data:/var/lib/postgresql/data
      - ./pgbackrest/pgbackrest.conf:/etc/pgbackrest/pgbackrest.conf
      - postgres-backups:/backup
      - backup-archive:/archive
      - postgres-socket:/var/run/postgresql
    networks:
      - pgnet
    restart: unless-stopped
    depends_on:
      - postgres-master
    command: ["tail", "-f", "/dev/null"]

  # Automated Backup Scheduler
  backup-scheduler:
    image: alpine:3.20
    container_name: ems-backup-scheduler
    environment:
      DISCORD_WEBHOOK_URL: ${DISCORD_WEBHOOK_URL}
    volumes:
      - ./scripts/backup.sh:/backup.sh
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      sh -c "
        apk add --no-cache dcron docker-cli curl jq &&
        chmod +x /backup.sh &&
        echo '0 2 * * * /backup.sh incr' > /etc/crontabs/root &&
        echo '0 3 * * 0 /backup.sh full' >> /etc/crontabs/root &&
        crond -f -l 2
      "
    networks:
      - pgnet
    restart: unless-stopped
    depends_on:
      - pgbackrest
